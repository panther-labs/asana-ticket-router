name: Airplane-CI

on:
  push:
    paths:
      - airplane/**

jobs:
  build-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: 3.10.6
      - name: Install Dependencies
        working-directory: airplane
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r test-requirements.txt
      - name: Compile all Python files
        working-directory: airplane
        if: github.ref != 'refs/heads/main'
        run: |
          python -m compileall .
      - name: Run tests in airplane directory
        working-directory: airplane
        run: |
          pytest tests --cov-report xml --cov=pyshared/ --cov=v2/pyshared/ --cov=.
      - name: Upload reports to Codecov
        working-directory: airplane
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: |
          # validate the signature
          curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring trustedkeys.gpg --import
          curl -Os https://uploader.codecov.io/latest/linux/codecov
          curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM
          curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM.sig
          gpgv codecov.SHA256SUM.sig codecov.SHA256SUM
          shasum -a 256 -c codecov.SHA256SUM
          # signature is good :+1:
          chmod +x codecov
          ./codecov -t ${CODECOV_TOKEN} -f coverage.xml -Z
